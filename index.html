<!-- Chosen Palette: Warm Neutrals & Earth Tones (Stone/Amber/Orange) -->
<!-- Application Structure Plan:
    1.  **Dashboard Overview:** Summary of trip stats.
    2.  **Interactive Timeline:** Tab-based navigation.
    3.  **Photography Command Center:** Checklists.
    4.  **Bookkeeping (Refactored):** Uses separate collections for robust sync.
    5.  **Firebase Integration:** Real-time listeners for multiple collections.
-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬ & å¯Œå£«å±± 11å¤©10å¤œ ç¨æ—…æ”å½±æŒ‡æ®ä¸­å¿ƒ (Pro Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        .active-tab {
            background-color: #d97706;
            color: white;
            border-color: #d97706;
        }
        .inactive-tab {
            background-color: white;
            color: #44403c;
            border-color: #e7e5e4;
        }
        .inactive-tab:hover {
            background-color: #fef3c7;
        }
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #22c55e;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Sync Status Indicator (Fixed Top Right) -->
    <div class="fixed top-4 right-4 z-50 bg-white/90 backdrop-blur border border-stone-200 rounded-full px-3 py-1 shadow-sm flex items-center gap-2 text-xs font-medium text-stone-600">
        <div id="syncStatusDot" class="w-2 h-2 rounded-full bg-stone-300"></div>
        <span id="syncStatusText">é€£æ¥ä¸­...</span>
    </div>

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto px-4 py-8 min-h-screen flex flex-col gap-8 relative">

        <!-- Header -->
        <header class="text-center space-y-2 mt-4">
            <h1 class="text-3xl md:text-4xl font-bold text-stone-900 tracking-tight">ğŸ‡¯ğŸ‡µ æ±äº¬ & å¯Œå£«å±± ç¨æ—…æ”å½±è¨ˆç•«</h1>
            <p class="text-stone-500 font-medium">2025/01/01 - 2025/01/11 (11å¤©10å¤œ) â€¢ é›²ç«¯åŒæ­¥ç‰ˆ Pro</p>
            <div class="flex justify-center gap-4 text-sm mt-4">
                <span class="px-3 py-1 bg-amber-100 text-amber-800 rounded-full">ğŸ“¸ æ”å½±å„ªå…ˆ</span>
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full">ğŸ—» å¯Œå£«å±±çµ•æ™¯</span>
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full">ğŸ”„ å³æ™‚å”ä½œ</span>
            </div>
            <p class="text-xs text-stone-400 mt-2">ğŸ“§ æ‰€æœ‰æ†‘è­‰ï¼šdaniel79865 ä¿¡ç®±</p>
        </header>

        <!-- Dashboard / Overview Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Intro Text & Major Expense Input -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200 flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-amber-700">ğŸ“‹ è¡Œç¨‹ç¸½è¦½</h2>
                <p class="mb-4 text-stone-600 leading-relaxed text-sm">
                    æ­¡è¿ä¾†åˆ°æ‚¨çš„æ—…è¡ŒæŒ‡æ®ä¸­å¿ƒã€‚é‡é»åŒ…å« <span class="font-bold text-stone-800">1/5 ä¸­å±±é‡‘æ¯è³½é¦¬</span>ã€<span class="font-bold text-stone-800">Shibuya Sky å¤•é™½</span> èˆ‡ <span class="font-bold text-stone-800">é€†å¯Œå£«</span>ã€‚
                </p>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-stone-50 p-3 rounded-lg text-center">
                        <div class="text-xl font-bold text-stone-800">6æ™š</div>
                        <div class="text-xs text-stone-500 uppercase">ç§‹è‘‰åŸä½å®¿</div>
                    </div>
                    <div class="bg-stone-50 p-3 rounded-lg text-center">
                        <div class="text-xl font-bold text-stone-800">3æ™š</div>
                        <div class="text-xs text-stone-500 uppercase">æ²³å£æ¹–ä½å®¿</div>
                    </div>
                </div>

                <!-- NEW: Add Major Expense Section -->
                <div class="mt-auto border-t border-stone-100 pt-4">
                    <button onclick="document.getElementById('majorExpenseForm').classList.toggle('hidden')" class="flex items-center gap-2 text-sm font-bold text-indigo-600 hover:text-indigo-800 transition-colors mb-2 w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        æ–°å¢é ä»˜ / å¤§é¡æ”¯å‡º (åˆ—å…¥ç¸½è¡¨)
                    </button>
                    
                    <div id="majorExpenseForm" class="hidden bg-indigo-50 p-3 rounded-xl space-y-2">
                        <input type="text" id="majorName" placeholder="é …ç›®åç¨± (å¦‚: ä¿éšª/å¤§é¤)" class="w-full text-sm p-2 rounded border border-indigo-200 focus:outline-none focus:border-indigo-500">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="majorPlatform" placeholder="å¹³å°/ä¾†æº" class="text-sm p-2 rounded border border-indigo-200 focus:outline-none focus:border-indigo-500">
                            <input type="number" id="majorPrice" placeholder="é‡‘é¡ (TWD)" class="text-sm p-2 rounded border border-indigo-200 focus:outline-none focus:border-indigo-500">
                        </div>
                        <input type="text" id="majorDetails" placeholder="å‚™è¨»ç´°ç¯€ (é¸å¡«)" class="w-full text-sm p-2 rounded border border-indigo-200 focus:outline-none focus:border-indigo-500">
                        <button onclick="window.addMajorExpense()" class="w-full bg-indigo-600 text-white text-sm font-bold py-2 rounded hover:bg-indigo-700 transition-colors">ç¢ºèªæ–°å¢</button>
                    </div>
                </div>
            </div>

            <!-- Chart: Trip Focus -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <h2 class="text-xl font-bold mb-4 text-amber-700">ğŸ¯ è¡Œç¨‹é‡å¿ƒåˆ†æ</h2>
                <div class="chart-container">
                    <canvas id="focusChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <nav class="sticky top-2 z-40 bg-stone-100/90 backdrop-blur-sm py-2 rounded-xl border border-stone-200 shadow-md">
            <div class="flex overflow-x-auto gap-2 px-2 hide-scroll" id="dayTabs">
                <!-- JS will populate these buttons -->
            </div>
        </nav>

        <!-- Dynamic Content Section -->
        <main id="mainContent" class="min-h-[500px]">
            <div class="flex flex-col items-center justify-center h-64 text-stone-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-stone-500 mb-2"></div>
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </main>

        <!-- Secondary Charts Section -->
        <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-stone-800">âš¡ é ä¼°å¼·åº¦ vs æ‰‹æ©Ÿå¯¦éš›æ­¥æ•¸</h2>
            </div>
            <p class="text-sm text-stone-500 mb-6">é•·æ¢åœ–ç‚ºé ä¼°ç–²å‹åº¦ï¼Œ<span class="text-blue-600 font-bold">æŠ˜ç·šç‚ºæ‚¨æ‰‹å‹•è¼¸å…¥çš„æ‰‹æ©Ÿæ­¥æ•¸</span>ã€‚</p>
            <div class="chart-container">
                <canvas id="intensityChart"></canvas>
            </div>
        </section>

        <!-- Photo Missions & Shopping Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-stone-800">ğŸ¥ æ”å½± & Reels ä»»å‹™</h2>
                    <span id="photoProgress" class="text-sm font-bold text-amber-600 bg-amber-100 px-3 py-1 rounded-full">0/10 å®Œæˆ</span>
                </div>
                <div class="space-y-3" id="photoChecklist"></div>
            </section>

            <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-stone-800">ğŸ›ï¸ è³¼ç‰© & ä¼´æ‰‹ç¦®æ¸…å–®</h2>
                    <span id="shopProgress" class="text-sm font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">0/12 è³¼å…¥</span>
                </div>
                <div class="space-y-3" id="shoppingChecklist"></div>
            </section>
        </div>

        <!-- NEW: Expenses & Tickets Summary -->
        <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
            <h2 class="text-xl font-bold text-stone-800 mb-4">ğŸ’° è²»ç”¨ç¸½è¡¨ (é ä»˜ + æ¯æ—¥è¨˜å¸³)</h2>
            <p class="text-sm text-stone-500 mb-4">æ‰€æœ‰é›»å­æ†‘è­‰å‡åœ¨ä¿¡ç®± <span class="font-mono bg-stone-100 px-1 rounded text-stone-700">daniel79865</span> ä¸­ã€‚è³‡æ–™ä¾†è‡ªå¤šå€‹é›²ç«¯é›†åˆåŒæ­¥ã€‚</p>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-stone-600" id="expensesTable">
                    <!-- JS will populate -->
                </table>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-stone-400 text-sm py-8 border-t border-stone-200">
            <p>2025 Tokyo & Fuji Solo Trip â€¢ Photography Itinerary</p>
        </footer>

    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables & State ---
        const TRIP_ID = 'tokyo_fuji_2025_fixed_v1';
        let currentDayIndex = 0;
        
        // Data Containers
        let checkedPhotos = new Set();
        let checkedShop = new Set();
        let dailyRoutineState = {};
        let stepCounts = {}; 
        let customExpenses = []; // From 'daily_expenses' collection
        let majorExpenses = []; // From 'major_expenses' collection
        
        // Chart instances
        let chartInstance = null; 
        let focusChartInstance = null;
        
        // Firebase Globals
        let db;
        let appId;

        // --- Static Data (Fixed) ---
        const fixedExpenses = [
            { name: "æ±äº¬ä¸ƒå¤©å…­å¤œä½å®¿", platform: "Agoda", details: "å‰ 6 æ™š + å¾Œ 1 æ™š (çµ„åˆ)", price: 7949 },
            { name: "æ©Ÿç¥¨ä¾†å›", platform: "Agoda", details: "TPE <-> NRT/HND", price: 9588 },
            { name: "å¯Œå£«å±±4å¤©3å¤œ + æ±äº¬1æ™š", platform: "Booking", details: "4543 (å¯Œå£«) + 1695 (æ±äº¬)", price: 6238 },
            { name: "Shibuya Sky é–€ç¥¨", platform: "å®˜ç¶²", details: "1/5 ä¸‹åˆ 3:00", price: 680, highlight: true },
            { name: "teamLab Borderless", platform: "Klook", details: "1/6 11:30 æ•¸ä½è—è¡“ç¾è¡“é¤¨", price: 958, highlight: true },
            { name: "æ–°å®¿-æ²³å£æ¹– å…¬è»Šä¾†å›", platform: "é ç´„", details: "å»:1/7 1109, å›:1/10 1106", price: 888 },
            { name: "å¯Œå£«å±±å…¨æ™¯ç´¢é“çºœè»Š", platform: "Klook", details: "1/8 å¾€è¿”ç¥¨", price: 201, highlight: true },
            { name: "eSIM ç¶²å¡", platform: "KKday", details: "æ—¥æœ¬ä¸Šç¶²", price: 287 }
        ];

        const itineraryData = [
            { day: 1, date: "1/1 (å››)", title: "æ—¥æœ¬æ©‹ãƒ»çš‡å±…ãƒ»æ–°å®¿ãƒ»éŠ€åº§", tag: "é«”åŠ›æŒ‘æˆ°", intensity: 9, location: "Tokyo", highlights: ["ä¸Šåˆï¼šæ—¥æœ¬æ©‹éº’éºŸåƒ", "ä¸Šåˆï¼šçš‡å±…å‰å»£å ´", "åˆé¤ï¼šShake Shack éŠ€åº§", "ä¸‹åˆï¼šé ˆè³€ç¥ç¤¾", "ä¸‹åˆï¼šæ±äº¬éƒ½å»³åŒ—å±•æœ›å®¤", "æ™šä¸Šï¼šéŠ€åº§æ­Œèˆä¼åº§å¤œæ‹"], food: "Shake Shack, Blue Bottle", tips: "å…ƒæ—¦å¾ˆå¤šåº—æ²’é–‹ã€‚" },
            { day: 2, date: "1/2 (äº”)", title: "ç§‹è‘‰åŸå»ºç¯‰ & æ–°å®¿è³¼ç‰©", tag: "æ”å½±+è³¼ç‰©", intensity: 6, location: "Tokyo", highlights: ["09:00 ç¥ç”°è¬ä¸–æ©‹", "10:00 è–æ©‹", "11:00 2k540 é«˜æ¶æ©‹ä¸‹", "åˆé¤ï¼šæ•˜æ•˜é™¢ ç‡’è‚‰ (12:30)", "ä¸‹åˆï¼šç§‹è‘‰åŸ/æ–°å®¿ è³¼ç‰©", "æ™šä¸Šï¼šç§‹è‘‰åŸè‡ªç”±æ´»å‹•"], food: "æ•˜æ•˜é™¢ (12:30 é ç´„)", tips: "æ—©ä¸Šæ‹å»ºç¯‰ï¼Œä¸‹åˆè³¼ç‰©ã€‚" },
            { day: 3, date: "1/3 (å…­)", title: "ä¸‹ç”ºé¢¨æƒ…ï¼šæ™´ç©ºå¡”ãƒ»æ·ºè‰", tag: "æ–‡åŒ–æ”å½±", intensity: 7, location: "Tokyo", highlights: ["æ¸…æ™¨ï¼šåé–“æ©‹ (æ™´ç©ºå¡”)", "ä¸Šåˆï¼šæ·ºè‰é›·é–€", "ä¸‹åˆï¼šä¸Šé‡ä¹‹æ£®", "ä¸‹åˆï¼šè°·ä¸­éŠ€åº§ã€Œå¤•é™½éšæ¢¯ã€", "æ™šé¤ï¼šè‚‰å±‹æ©«ç”º (18:00)"], food: "æ·ºè‰é°»é­šé£¯, è‚‰å±‹æ©«ç”º", tips: "è°·ä¸­éŠ€åº§å¤•é™½å¿…æ‹ã€‚" },
            { day: 4, date: "1/4 (æ—¥)", title: "è³½é¦¬æ—¥ & ç§‹è‘‰åŸå¤œç”Ÿæ´»", tag: "ç†±è¡€", intensity: 8, location: "Chiba/Tokyo", highlights: ["å…¨æ—¥ï¼šä¸­å±±ç«¶é¦¬å ´ (GIII)", "æ‹æ”ï¼šè¬é¦¬å¥”é¨°", "æ·±å¤œï¼šMOGRA", "Option: 63 angel"], food: "é¦¬å ´å…§Bç´šç¾é£Ÿ", tips: "é€±å…­æ™šä¸Šå¤œåº—æ°£æ°›ä½³ã€‚" },
            { day: 5, date: "1/5 (ä¸€)", title: "ä»£å®˜å±±ãƒ»æ¾€è°· SKY", tag: "æ™‚å°šè¡—æ‹", intensity: 6, location: "Tokyo", highlights: ["ä¸Šåˆï¼šä»£å®˜å±± è”¦å±‹æ›¸åº—", "ä¸‹åˆï¼šæƒ æ¯”å£½èŠ±åœ’", "15:00 SHIBUYA SKY", "æ™šä¸Šï¼šæ¾€è°·åå­—è·¯å£", "æ™šé¤ï¼šTerumae (19:00)"], food: "ç‚¸ç‰›æ’, Terumae", tips: "SHIBUYA SKY 3é»å…¥å ´ã€‚" },
            { day: 6, date: "1/6 (äºŒ)", title: "éº»å¸ƒå°ãƒ»æ±äº¬å¡”", tag: "è—è¡“çµ•æ™¯", intensity: 5, location: "Tokyo", highlights: ["11:30 teamLab Borderless", "æ‹æ”ï¼šç¥è°·ç”ºè»Šç«™", "æ‹æ”ï¼šèŠå…¬åœ’ (æ±äº¬éµå¡”)", "æ·±å¤œï¼šLive House"], food: "é›æ¹¯æ‹‰éºµ ç¯", tips: "teamLab 11:30 å…¥å ´ã€‚" },
            { day: 7, date: "1/7 (ä¸‰)", title: "ç§»å‹•æ—¥ï¼šæ±äº¬ â†’ æ²³å£æ¹–", tag: "ç§»å‹•/é¢¨æ™¯", intensity: 4, location: "Fuji", highlights: ["13:15 æ–°å®¿é«˜é€Ÿå·´å£«", "åˆé¤ï¼šç‚¸ç‰›æ’ Koushuya", "ä¸‹åˆï¼šæ–°å€‰å±±æ·ºé–“å…¬åœ’", "æ‹æ”ï¼šæœ¬ç”ºäºŒä¸ç›®"], food: "ç‚¸ç‰›æ’ Koushuya", tips: "è¨˜å¾—æå‰åˆ°å·´å£«ç¸½ç«™ã€‚" },
            { day: 8, date: "1/8 (å››)", title: "æ²³å£æ¹–ç’°æ¹–æ”å½±", tag: "è‡ªç„¶é¢¨å…‰", intensity: 7, location: "Fuji", highlights: ["æ¸…æ™¨ï¼šæ¹–ç•”æ—¥å‡º (é€†å¯Œå£«)", "æ™¯é»ï¼šå¤§çŸ³å…¬åœ’", "æ™¯é»ï¼šéŸ³æ¨‚ç›’ä¹‹æ£®", "æ™¯é»ï¼šå¤©ä¸Šå±±çºœè»Š"], food: "æ²³å£æ¹–å‘¨é‚Š", tips: "çºœè»Šç¥¨å·²è²·ã€‚" },
            { day: 9, date: "1/9 (äº”)", title: "å¿é‡å…«æµ·", tag: "å‚³çµ±å»ºç¯‰", intensity: 5, location: "Fuji", highlights: ["å…¨æ—¥ï¼šå¿é‡å…«æµ·", "æ‹æ”ï¼šé¡æ±  (é€†å¯Œå£«)", "æ‹æ”ï¼šå‚³çµ±èŒ…è‘ºå±‹é ‚"], food: "å¿é‡å…«æµ·å°åƒ", tips: "éŠå®¢å¤šï¼Œå»ºè­°æ—©åˆ°ã€‚" },
            { day: 10, date: "1/10 (å…­)", title: "å¯Œå£«æ€¥ãƒ»å›æ±äº¬", tag: "éŠæ¨‚/ç§»å‹•", intensity: 6, location: "Fuji/Tokyo", highlights: ["ä¸Šåˆï¼šå¯Œå£«è¦‹æ©‹", "11:10 æ²³å£æ¹–ç™¼è»Šå›æ–°å®¿", "ä¸‹åˆï¼šæ±äº¬æœ€å¾Œè¡åˆº", "å‚æ™šï¼šå…¥ä½æœ€å¾Œä¸€æ™š"], food: "æ±äº¬å¸‚å€", tips: "11:10 å‰å›åˆ°è»Šç«™ã€‚" },
            { day: 11, date: "1/11 (æ—¥)", title: "å›ç¨‹", tag: "è¿”å®¶", intensity: 2, location: "Airport", highlights: ["ä¸Šåˆï¼šç¾½ç”°æ©Ÿå ´ (HND)", "æœ€å¾Œè¡åˆºï¼šæ©Ÿå ´ä¼´æ‰‹ç¦®"], food: "é£›æ©Ÿé¤", tips: "æ³¨æ„é¦–ç­è»Šæ™‚é–“ã€‚" }
        ];

        const photoMissions = [
            { id: 1, text: "Day 1: éŠ€åº§/æœ‰æ¨‚ç”º è»Šè»Œå¤œæ™¯", type: "Photo" },
            { id: 2, text: "Day 2: è–æ©‹ ä¸‰ç·šé›»è»Šäº¤æœƒ", type: "Photo" },
            { id: 3, text: "Day 3: åé–“æ©‹ æ™´ç©ºå¡”å®Œç¾å€’å½±", type: "Photo" },
            { id: 4, text: "Day 3: è°·ä¸­éŠ€åº§ å¤•é™½éšæ¢¯å‰ªå½±", type: "Photo" },
            { id: 5, text: "Day 4: ä¸­å±±ç«¶é¦¬å ´ è¬é¦¬å¥”é¨°", type: "Photo" },
            { id: 6, text: "Day 5: SHIBUYA SKY ç™¾è¬å¤œæ™¯", type: "Photo" },
            { id: 7, text: "Day 6: teamLab Borderless å‰ªå½±", type: "Photo" },
            { id: 8, text: "Day 6: èŠå…¬åœ’ ç´…ç™½æ±äº¬éµå¡”", type: "Photo" },
            { id: 9, text: "Day 7: ä¸‹å‰ç”° æœ¬ç”ºäºŒä¸ç›® é•·ç„¦", type: "Photo" },
            { id: 10, text: "Day 8: æ²³å£æ¹– é€†å¯Œå£« (æ¸…æ™¨)", type: "Photo" },
            { id: 11, text: "Reel: 'The Next Station is Tokyo'", type: "Video" },
            { id: 12, text: "Reel: Shibuya Sky x å¤©æ°£ä¹‹å­", type: "Video" }
        ];

        const shoppingList = [
            { item: "çŒ©çŒ©ä¹‹æ¡ (ç›¸æ©Ÿè…³æ¶)", loc: "Yodobashi Akiba", cat: "Gear" },
            { item: "æ¸›è‚¥è—¥ (Onaka/Naishi)", loc: "æ¾æœ¬æ¸…", cat: "Drugstore" },
            { item: "è€åª½çš„èƒŒå¿ƒ", loc: "Uniqlo éŠ€åº§", cat: "Clothing" },
            { item: "New York Perfect Cheese", loc: "æ±äº¬ç«™", cat: "Souvenir" },
            { item: "ç™½è‰²æˆ€äºº", loc: "æ©Ÿå ´", cat: "Souvenir" },
            { item: "Royce ç”Ÿå·§å…‹åŠ›", loc: "æ©Ÿå ´", cat: "Souvenir" },
            { item: "YoroshiåŒ–ç²§å ‚ 365è­·å”‡è†", loc: "æ·ºè‰", cat: "Souvenir" },
            { item: "FUJIYAMA COOKIE", loc: "æ²³å£æ¹–", cat: "Souvenir" },
            { item: "LAWSON è‰è“ç‰›å¥¶", loc: "ä¾¿åˆ©å•†åº—", cat: "Daily Eat" },
            { item: "OHAYO ç„¦ç³–çƒ¤å¸ƒè•¾å†°æ·‡æ·‹", loc: "ä¾¿åˆ©å•†åº—", cat: "Daily Eat" },
            { item: "æ¯æ™šä¸€ç½å•¤é…’", loc: "ä¾¿åˆ©å•†åº—", cat: "Daily Eat" },
            { item: "Sweet Gardenå¯Œå£«èµ·å£«è›‹ç³•", loc: "æ²³å£æ¹–", cat: "Daily Eat" }
        ];
        
        const dailyRoutineItems = [
            { id: 'run', text: 'æ™¨é–“è·‘æ­¥ / æ•£æ­¥', icon: 'ğŸƒ', isFujiOnly: false },
            { id: 'milk', text: 'LAWSON è‰è“ç‰›å¥¶', icon: 'ğŸ“', isFujiOnly: false },
            { id: 'icecream', text: 'ç„¦ç³–çƒ¤å¸ƒè•¾å†°æ·‡æ·‹', icon: 'ğŸ®', isFujiOnly: false },
            { id: 'beer', text: 'å–ä¸€ç½å•¤é…’', icon: 'ğŸº', isFujiOnly: false },
            { id: 'fuji_cake', text: 'å¯Œå£«é›ªç²‰èµ·å£«è›‹ç³•', icon: 'ğŸ—»', isFujiOnly: true }
        ];

        // --- Core Interaction Functions (Attached to Window) ---

        window.toggleRoutine = function(dayIndex, itemId) {
            const stateKey = `${dayIndex}_${itemId}`;
            dailyRoutineState[stateKey] = !dailyRoutineState[stateKey];
            renderContent(dayIndex);
            syncTripState(); 
        };

        window.togglePhoto = function(idx) {
            if (checkedPhotos.has(idx)) checkedPhotos.delete(idx);
            else checkedPhotos.add(idx);
            renderChecklists();
            syncTripState();
        };

        window.toggleShop = function(idx) {
            if (checkedShop.has(idx)) checkedShop.delete(idx);
            else checkedShop.add(idx);
            renderChecklists();
            syncTripState();
        };

        window.updateSteps = function(dayIndex, value) {
            stepCounts[dayIndex] = parseInt(value) || 0;
            renderCharts(); 
            syncTripState();
        };

        // --- NEW: Firestore Sub-Collection Operations (Robust Sync) ---

        window.addMajorExpense = async function() {
            const name = document.getElementById('majorName').value.trim();
            const platform = document.getElementById('majorPlatform').value.trim();
            const price = parseInt(document.getElementById('majorPrice').value);
            const details = document.getElementById('majorDetails').value.trim();

            if (!name || isNaN(price)) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®åç¨±èˆ‡é‡‘é¡");
                return;
            }

            try {
                // Add to 'major_expenses' collection using unique auto-ID
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'major_expenses'), {
                    tripId: TRIP_ID,
                    name,
                    platform: platform || "è‡ªè¨‚",
                    price,
                    details: details || "",
                    createdAt: Date.now()
                });
                
                // Clear form
                document.getElementById('majorName').value = "";
                document.getElementById('majorPlatform').value = "";
                document.getElementById('majorPrice').value = "";
                document.getElementById('majorDetails').value = "";
                alert("å·²æ–°å¢è‡³å¤§é¡æ”¯å‡ºï¼ˆé›²ç«¯åŒæ­¥ï¼‰ï¼");
            } catch (e) {
                console.error("Error adding major expense", e);
                alert("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        };

        window.deleteMajorExpense = async function(docId) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'major_expenses', docId));
            } catch (e) {
                console.error("Error deleting major expense", e);
            }
        };

        window.addExpense = async function(dayIndex) {
            const name = document.getElementById(`expense-name-${dayIndex}`).value.trim();
            const price = parseInt(document.getElementById(`expense-price-${dayIndex}`).value);

            if (!name || isNaN(price)) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®åç¨±èˆ‡é‡‘é¡");
                return;
            }

            try {
                // Add to 'daily_expenses' collection
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'daily_expenses'), {
                    tripId: TRIP_ID,
                    dayIndex,
                    name,
                    price,
                    createdAt: Date.now()
                });
                // Clear form handled in render if we want, or manually here
                document.getElementById(`expense-name-${dayIndex}`).value = "";
                document.getElementById(`expense-price-${dayIndex}`).value = "";
            } catch (e) {
                console.error("Error adding daily expense", e);
            }
        };

        window.deleteExpense = async function(docId, dayIndex) {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_expenses', docId));
            } catch (e) {
                console.error("Error deleting daily expense", e);
            }
        };

        // --- Render Functions ---

        const dayTabs = document.getElementById('dayTabs');
        const mainContent = document.getElementById('mainContent');
        const photoChecklist = document.getElementById('photoChecklist');
        const shoppingChecklist = document.getElementById('shoppingChecklist');
        const expensesTable = document.getElementById('expensesTable');

        function renderTabs() {
            dayTabs.innerHTML = '';
            itineraryData.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 px-5 py-2 rounded-lg text-sm font-medium transition-all duration-200 border ${index === currentDayIndex ? 'active-tab shadow-md' : 'inactive-tab'}`;
                btn.textContent = `Day ${day.day}`;
                btn.onclick = () => {
                    currentDayIndex = index;
                    renderTabs();
                    renderContent(index);
                };
                dayTabs.appendChild(btn);
            });
        }

        function renderContent(index) {
            const data = itineraryData[index];
            const isFujiArea = data.location === 'Fuji' || data.location.includes('Fuji');
            const currentSteps = stepCounts[index] || '';
            
            // Filter expenses from the global synced array
            const dailyExpenses = customExpenses.filter(e => e.dayIndex === index);
            const dailyTotal = dailyExpenses.reduce((sum, e) => sum + e.price, 0);

            // Routine HTML
            let routineHtml = '';
            dailyRoutineItems.forEach(item => {
                if (item.isFujiOnly && !isFujiArea) return;
                const stateKey = `${index}_${item.id}`;
                const isChecked = dailyRoutineState[stateKey] || false;
                
                routineHtml += `
                    <div class="flex items-center gap-3 p-3 mb-2 rounded-lg cursor-pointer transition-all ${isChecked ? 'bg-green-50 border border-green-200' : 'bg-white border border-stone-200 hover:border-stone-400'}" 
                            onclick="window.toggleRoutine(${index}, '${item.id}')">
                        <div class="w-5 h-5 flex items-center justify-center rounded border ${isChecked ? 'bg-green-500 border-green-500 text-white' : 'border-stone-300'}">
                            ${isChecked ? 'âœ“' : ''}
                        </div>
                        <div class="flex-1 text-sm font-medium ${isChecked ? 'text-stone-400 line-through' : 'text-stone-700'}">
                            <span class="mr-1">${item.icon}</span> ${item.text}
                        </div>
                    </div>
                `;
            });

            // Expense List HTML
            let expensesListHtml = '';
            if (dailyExpenses.length > 0) {
                expensesListHtml = `<div class="mt-3 space-y-2">`;
                dailyExpenses.forEach(exp => {
                    expensesListHtml += `
                        <div class="flex justify-between items-center bg-white p-2 rounded border border-stone-100 expense-item">
                            <span class="text-sm text-stone-700">${exp.name}</span>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-mono text-stone-600">$${exp.price}</span>
                                <button onclick="window.deleteExpense('${exp.id}', ${index})" class="text-red-400 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
                expensesListHtml += `</div>`;
            } else {
                expensesListHtml = `<p class="text-xs text-stone-400 mt-2 text-center italic">ä»Šæ—¥å°šæœªæ–°å¢æ¶ˆè²»</p>`;
            }

            mainContent.innerHTML = `
                <div class="bg-white rounded-3xl shadow-lg border border-stone-200 overflow-hidden relative">
                    <div class="p-8 ${isFujiArea ? 'bg-gradient-to-r from-blue-50 to-indigo-50' : 'bg-gradient-to-r from-amber-50 to-orange-50'}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-3xl font-bold text-stone-800 mb-2">${data.date} ${data.title}</h2>
                                <div class="flex gap-2">
                                    <span class="px-3 py-1 text-xs font-bold uppercase tracking-wide rounded-full bg-white text-stone-600 border border-stone-200">
                                        ğŸ“ ${data.location}
                                    </span>
                                    <span class="px-3 py-1 text-xs font-bold uppercase tracking-wide rounded-full ${data.intensity >= 8 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                        âš¡ å¼·åº¦: ${data.intensity}/10
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-8">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                            <div class="lg:col-span-2 space-y-6">
                                <div>
                                    <h3 class="text-lg font-bold text-stone-700 mb-4 border-b pb-2 border-stone-100">è¡Œç¨‹äº®é»</h3>
                                    <ul class="space-y-4">
                                        ${data.highlights.map(item => `
                                            <li class="flex items-start gap-3">
                                                <span class="mt-1.5 w-2 h-2 rounded-full ${item.includes('è»Šæ¬¡') || item.includes('é ç´„') ? 'bg-blue-500' : (item.includes('æ‹æ”') ? 'bg-red-500' : 'bg-amber-500')} flex-shrink-0"></span>
                                                <span class="text-stone-700 leading-relaxed ${item.includes('è»Šæ¬¡') || item.includes('é ç´„') ? 'font-bold' : ''}">${item}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="bg-white border border-blue-200 rounded-xl p-4 flex items-center justify-between shadow-sm">
                                    <div class="flex items-center gap-3">
                                         <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.85-2.98 5.54-3 8h6c.02-2.46-2.98-5.15-3-8 0-4.2 1.63-6 3.5-6 3.01 0 4.47 3.28 4.5 6 .03 2.5-1 3.5-1 5.62V16h-1v6h2v-6h1v6h2v-6h1v-2c0-2.31.7-3.58 1-5H3c.3 1.42 1 2.69 1 5v2h1v-6h1v6h2v-6h1v6h2v-6z"></path></svg>
                                         </div>
                                         <div>
                                             <h4 class="font-bold text-stone-700">æ‰‹æ©Ÿæ­¥æ•¸ç´€éŒ„</h4>
                                         </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="stepInput" 
                                               class="w-24 border border-stone-300 rounded-lg px-3 py-2 text-right font-mono focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none" 
                                               placeholder="0" 
                                               value="${currentSteps}"
                                               onchange="window.updateSteps(${index}, this.value)">
                                        <span class="text-sm text-stone-500">æ­¥</span>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-6">
                                <div class="bg-stone-50 rounded-2xl p-5 border border-stone-100">
                                    <h3 class="text-sm font-bold text-stone-500 uppercase mb-3 flex items-center gap-2"><span>ğŸ“…</span> æ¯æ—¥å„€å¼ Checklist</h3>
                                    <div class="flex flex-col">${routineHtml}</div>
                                </div>
                                <div class="bg-indigo-50 rounded-2xl p-5 border border-indigo-100">
                                    <h3 class="text-sm font-bold text-indigo-800 uppercase mb-3 flex items-center gap-2 justify-between">
                                        <span>ğŸ’¸ ä»Šæ—¥è¨˜å¸³ (å°é¡)</span>
                                        <span class="text-xs bg-white px-2 py-0.5 rounded border border-indigo-100 text-indigo-600">å°è¨ˆ: $${dailyTotal}</span>
                                    </h3>
                                    <div class="flex gap-2 mb-3">
                                        <input type="text" id="expense-name-${index}" placeholder="é …ç›®" class="w-full rounded border border-stone-300 px-2 py-1 text-sm focus:outline-none focus:border-indigo-400">
                                        <input type="number" id="expense-price-${index}" placeholder="$" class="w-20 rounded border border-stone-300 px-2 py-1 text-sm focus:outline-none focus:border-indigo-400">
                                        <button onclick="window.addExpense(${index})" class="bg-indigo-600 text-white rounded px-3 py-1 text-sm hover:bg-indigo-700 transition-colors">+</button>
                                    </div>
                                    ${expensesListHtml}
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-stone-50 p-4 rounded-xl">
                                <h4 class="text-sm font-bold text-stone-500 uppercase mb-2">ğŸ½ï¸ é¤é£² & é ç´„</h4>
                                <p class="text-stone-800 font-medium">${data.food}</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <h4 class="text-sm font-bold text-amber-600 uppercase mb-2">ğŸ’¡ æ”å½±ç­†è¨˜ / è²¼å¿ƒæé†’</h4>
                                <p class="text-stone-800 text-sm">${data.tips}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChecklists() {
            // Photos
            photoChecklist.innerHTML = '';
            photoMissions.forEach((item, idx) => {
                const isChecked = checkedPhotos.has(idx);
                const div = document.createElement('div');
                div.className = `flex items-center justify-between gap-3 p-3 rounded-lg border transition-all ${isChecked ? 'bg-stone-50 border-stone-200' : 'bg-white border-stone-100 hover:border-amber-300 hover:shadow-sm'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3 cursor-pointer flex-grow" onclick="window.togglePhoto(${idx})">
                        <div class="w-5 h-5 rounded border flex items-center justify-center flex-shrink-0 ${isChecked ? 'bg-amber-500 border-amber-500 text-white' : 'border-stone-300'}">
                            ${isChecked ? 'âœ“' : ''}
                        </div>
                        <div><div class="text-sm font-medium ${isChecked ? 'line-through text-stone-400' : 'text-stone-700'}">${item.text}</div></div>
                    </div>`;
                photoChecklist.appendChild(div);
            });
            document.getElementById('photoProgress').textContent = `${checkedPhotos.size}/${photoMissions.length} å®Œæˆ`;

            // Shopping
            shoppingChecklist.innerHTML = '';
            shoppingList.forEach((item, idx) => {
                const isChecked = checkedShop.has(idx);
                const div = document.createElement('div');
                div.className = `flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${isChecked ? 'bg-stone-50 border-stone-200 opacity-60' : 'bg-white border-stone-100 hover:border-blue-300 hover:shadow-sm'}`;
                div.onclick = () => window.toggleShop(idx);
                div.innerHTML = `
                    <div class="w-5 h-5 rounded border flex items-center justify-center ${isChecked ? 'bg-blue-500 border-blue-500 text-white' : 'border-stone-300'}">${isChecked ? 'âœ“' : ''}</div>
                    <div><div class="text-sm font-medium ${isChecked ? 'line-through text-stone-400' : 'text-stone-700'}">${item.item}</div><div class="text-xs text-stone-400">${item.loc}</div></div>`;
                shoppingChecklist.appendChild(div);
            });
            document.getElementById('shopProgress').textContent = `${checkedShop.size}/${shoppingList.length} è³¼å…¥`;
        }

        function renderExpensesTable() {
            let html = `
                <thead class="text-xs text-stone-700 uppercase bg-stone-50">
                    <tr>
                        <th class="px-6 py-3">é …ç›®</th>
                        <th class="px-6 py-3">å¹³å°/é¡åˆ¥</th>
                        <th class="px-6 py-3">è©³ç´°è³‡è¨Š / æ—¥æœŸ</th>
                        <th class="px-6 py-3 text-right">é‡‘é¡ (TWD)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-stone-100">`;

            let grandTotal = 0;

            // 1. Fixed
            fixedExpenses.forEach(exp => {
                grandTotal += exp.price;
                html += `
                    <tr class="bg-white border-b hover:bg-stone-50">
                        <td class="px-6 py-4 font-medium text-stone-900">${exp.name}</td>
                        <td class="px-6 py-4">${exp.platform}</td>
                        <td class="px-6 py-4 ${exp.highlight ? 'text-amber-600 font-bold' : ''}">${exp.details}</td>
                        <td class="px-6 py-4 text-right">${exp.price.toLocaleString()}</td>
                    </tr>`;
            });

            // 2. Major (Synced from Collection)
            if (majorExpenses.length > 0) {
                 // Sort by creation time
                 const sortedMajor = [...majorExpenses].sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
                 sortedMajor.forEach(exp => {
                    grandTotal += exp.price;
                    html += `
                        <tr class="bg-amber-50/50 border-b hover:bg-amber-50 group">
                            <td class="px-6 py-4 font-medium text-stone-900 flex items-center gap-2">
                                ${exp.name}
                                <button onclick="window.deleteMajorExpense('${exp.id}')" class="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </td>
                            <td class="px-6 py-4 text-stone-600">${exp.platform}</td>
                            <td class="px-6 py-4 text-stone-500 italic">${exp.details}</td>
                            <td class="px-6 py-4 text-right">${exp.price.toLocaleString()}</td>
                        </tr>`;
                });
            }

            // 3. Daily (Synced from Collection)
            if (customExpenses.length > 0) {
                html += `<tr><td colspan="4" class="px-6 py-2 text-xs font-bold text-stone-500 uppercase text-center tracking-wider bg-stone-100">â¬‡ï¸ æ—…é€”è¨˜å¸³ (ç¾åœ°å°é¡æ¶ˆè²») â¬‡ï¸</td></tr>`;
                const sortedCustom = [...customExpenses].sort((a, b) => a.dayIndex - b.dayIndex);
                sortedCustom.forEach(exp => {
                    grandTotal += exp.price;
                    html += `
                        <tr class="bg-indigo-50/30 border-b hover:bg-indigo-50">
                            <td class="px-6 py-4 font-medium text-stone-900">${exp.name}</td>
                            <td class="px-6 py-4 text-stone-500">æ¯æ—¥è¨˜å¸³</td>
                            <td class="px-6 py-4 text-indigo-600 font-medium">Day ${exp.dayIndex + 1}</td>
                            <td class="px-6 py-4 text-right">${exp.price.toLocaleString()}</td>
                        </tr>`;
                });
            }

            html += `
                </tbody>
                <tfoot class="bg-stone-100 font-bold text-stone-900">
                    <tr>
                        <td class="px-6 py-3 text-base">ç¸½è¨ˆ (TWD)</td>
                        <td class="px-6 py-3"></td>
                        <td class="px-6 py-3"></td>
                        <td class="px-6 py-3 text-right text-base text-indigo-700">${grandTotal.toLocaleString()}</td>
                    </tr>
                </tfoot>`;
            expensesTable.innerHTML = html;
        }

        function renderCharts() {
            if (typeof Chart === 'undefined') return;
            
            // Focus Chart
            const ctxFocus = document.getElementById('focusChart')?.getContext('2d');
            if (ctxFocus) {
                if (focusChartInstance) focusChartInstance.destroy();
                focusChartInstance = new Chart(ctxFocus, {
                    type: 'doughnut',
                    data: {
                        labels: ['æ”å½±', 'è³¼ç‰©', 'ç¾é£Ÿ', 'ç§»å‹•', 'å¨›æ¨‚'],
                        datasets: [{ data: [45, 15, 20, 10, 10], backgroundColor: ['#d97706', '#3b82f6', '#10b981', '#6b7280', '#8b5cf6'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }

            // Intensity Chart
            const ctxIntensity = document.getElementById('intensityChart')?.getContext('2d');
            if (ctxIntensity) {
                const stepsData = itineraryData.map((_, i) => stepCounts[i] || 0);
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctxIntensity, {
                    type: 'bar',
                    data: {
                        labels: itineraryData.map(d => `Day ${d.day}`),
                        datasets: [
                            { label: 'é ä¼°å¼·åº¦', data: itineraryData.map(d => d.intensity), backgroundColor: itineraryData.map(d => d.intensity >= 8 ? '#fca5a5' : (d.intensity >= 6 ? '#fcd34d' : '#6ee7b7')), order: 2 },
                            { label: 'å¯¦éš›æ­¥æ•¸', data: stepsData, borderColor: '#2563eb', backgroundColor: '#2563eb', type: 'line', tension: 0.3, yAxisID: 'y1', order: 1 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 10, display: false }, y1: { beginAtZero: true, position: 'right', suggestedMax: 20000, grid: { drawOnChartArea: true } } }
                    }
                });
            }
        }

        // --- Init & Sync ---

        function updateSyncStatus(status) {
            const dot = document.getElementById('syncStatusDot');
            const text = document.getElementById('syncStatusText');
            if(status === 'active') {
                dot.style.backgroundColor = '#22c55e'; // Green
                text.textContent = 'å·²åŒæ­¥';
            } else {
                dot.style.backgroundColor = '#f59e0b'; // Amber
                text.textContent = 'åŒæ­¥ä¸­...';
            }
        }

        async function initApp() {
            renderTabs();
            renderContent(0);
            renderChecklists();
            renderExpensesTable();
            setTimeout(renderCharts, 100);

            try {
                if (typeof __firebase_config === 'undefined') return;
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // FIXED AUTHENTICATION LOGIC
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();

                // Double check user exists before attaching listeners
                if (!auth.currentUser) {
                    console.error("Auth failed, no user");
                    return;
                }

                // 1. Trip State Listener (Checkboxes, Steps)
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trip_state', TRIP_ID);
                onSnapshot(docRef, (docSnap) => {
                    updateSyncStatus('active');
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        checkedPhotos = new Set(data.checkedPhotos || []);
                        checkedShop = new Set(data.checkedShop || []);
                        dailyRoutineState = data.dailyRoutine || {};
                        stepCounts = data.stepCounts || {};
                        renderChecklists();
                        renderContent(currentDayIndex); // Be careful with input focus here? Actually checkboxes are fine.
                        renderCharts();
                    }
                }, (error) => {
                    console.error("Error watching trip state:", error);
                    updateSyncStatus('error');
                });

                // 2. Major Expenses Listener (Collection)
                // Filter by tripId manually in JS as per "No complex queries" rule preference in limited env,
                // or just fetch the collection. This is a dedicated collection for this trip data essentially.
                const majorColRef = collection(db, 'artifacts', appId, 'public', 'data', 'major_expenses');
                onSnapshot(majorColRef, (snapshot) => {
                    updateSyncStatus('active');
                    majorExpenses = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(item => item.tripId === TRIP_ID);
                    renderExpensesTable();
                }, (error) => {
                    console.error("Error watching major expenses:", error);
                });

                // 3. Daily Expenses Listener (Collection)
                const dailyColRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_expenses');
                onSnapshot(dailyColRef, (snapshot) => {
                    updateSyncStatus('active');
                    customExpenses = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(item => item.tripId === TRIP_ID);
                    renderContent(currentDayIndex);
                    renderExpensesTable();
                }, (error) => {
                    console.error("Error watching daily expenses:", error);
                });

            } catch (err) {
                console.error("Firebase Init Error:", err);
            }
        }

        // Sync Trip State (Checkboxes etc)
        async function syncTripState() {
            if (!db) return;
            updateSyncStatus('pending');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trip_state', TRIP_ID);
            try {
                await setDoc(docRef, {
                    checkedPhotos: Array.from(checkedPhotos),
                    checkedShop: Array.from(checkedShop),
                    dailyRoutine: dailyRoutineState,
                    stepCounts: stepCounts
                }, { merge: true });
            } catch(e) { console.error(e); }
        }

        initApp();

    </script>
</body>
</html>
