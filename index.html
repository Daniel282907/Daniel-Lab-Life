<!-- Chosen Palette: Warm Neutrals & Earth Tones (Stone/Amber/Orange) -->
<!-- Application Structure Plan:
    1.  **Dashboard Overview:** Summary of trip stats.
    2.  **Interactive Timeline:** Tab-based navigation.
    3.  **Photography Command Center:** Checklists.
    4.  **Logistics & Loot:** Shopping list.
    5.  **Daily Routine Checklist:** Running, Snacks, Beer, Fuji Cake.
    6.  **Bookkeeping:** Daily expense tracking syncing to summary.
    7.  **Firebase Integration:** Real-time sync for checklist states.
-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬ & å¯Œå£«å±± 11å¤©10å¤œ ç¨æ—…æ”å½±æŒ‡æ®ä¸­å¿ƒ (Sync Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js with crossorigin to prevent Script Error on load issues -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        .active-tab {
            background-color: #d97706; /* amber-600 */
            color: white;
            border-color: #d97706;
        }
        .inactive-tab {
            background-color: white;
            color: #44403c; /* stone-700 */
            border-color: #e7e5e4; /* stone-200 */
        }
        .inactive-tab:hover {
            background-color: #fef3c7; /* amber-100 */
        }
        /* Custom scrollbar for horizontal tabs */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Fade in animation for new expenses */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .expense-item {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto px-4 py-8 min-h-screen flex flex-col gap-8 relative">

        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-3xl md:text-4xl font-bold text-stone-900 tracking-tight">ğŸ‡¯ğŸ‡µ æ±äº¬ & å¯Œå£«å±± ç¨æ—…æ”å½±è¨ˆç•«</h1>
            <p class="text-stone-500 font-medium">2025/01/01 - 2025/01/11 (11å¤©10å¤œ) â€¢ é›²ç«¯åŒæ­¥ç‰ˆ</p>
            <div class="flex justify-center gap-4 text-sm mt-4">
                <span class="px-3 py-1 bg-amber-100 text-amber-800 rounded-full">ğŸ“¸ æ”å½±å„ªå…ˆ</span>
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full">ğŸ—» å¯Œå£«å±±çµ•æ™¯</span>
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full">ğŸ”„ å³æ™‚åŒæ­¥</span>
            </div>
            <p class="text-xs text-stone-400 mt-2">ğŸ“§ æ‰€æœ‰æ†‘è­‰ï¼šdaniel79865 ä¿¡ç®±</p>
        </header>

        <!-- Dashboard / Overview Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Intro Text -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200 flex flex-col justify-center">
                <h2 class="text-xl font-bold mb-4 text-amber-700">ğŸ“‹ è¡Œç¨‹ç¸½è¦½</h2>
                <p class="mb-4 text-stone-600 leading-relaxed">
                    æ­¡è¿ä¾†åˆ°æ‚¨çš„æ—…è¡ŒæŒ‡æ®ä¸­å¿ƒã€‚æœ¬è¡Œç¨‹å°ˆç‚ºæ”å½±æ„›å¥½è€…è¨­è¨ˆï¼Œæ¶µè“‹æ±äº¬çš„ç¾ä»£èˆ‡ä¸‹ç”ºé¢¨æƒ…ï¼Œä»¥åŠæ²³å£æ¹–çš„å¯Œå£«å±±çµ•æ™¯ã€‚
                    é‡é»åŒ…å« <span class="font-bold text-stone-800">1/5 ä¸­å±±é‡‘æ¯è³½é¦¬</span>ã€<span class="font-bold text-stone-800">Shibuya Sky å¤•é™½</span> èˆ‡ <span class="font-bold text-stone-800">é€†å¯Œå£«</span> æ‹æ”ã€‚
                </p>
                <div class="grid grid-cols-2 gap-4 mt-auto">
                    <div class="bg-stone-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-stone-800">6æ™š</div>
                        <div class="text-xs text-stone-500 uppercase">ç§‹è‘‰åŸä½å®¿</div>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-stone-800">3æ™š</div>
                        <div class="text-xs text-stone-500 uppercase">æ²³å£æ¹–ä½å®¿</div>
                    </div>
                </div>
            </div>

            <!-- Chart: Trip Focus -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <h2 class="text-xl font-bold mb-4 text-amber-700">ğŸ¯ è¡Œç¨‹é‡å¿ƒåˆ†æ</h2>
                <div class="chart-container">
                    <canvas id="focusChart"></canvas>
                </div>
                <p class="text-xs text-center text-stone-400 mt-2">æ”å½±èˆ‡æ¢ç´¢ä½”æ¯”æœ€é«˜ï¼Œè³¼ç‰©é›†ä¸­æ–¼ç‰¹å®šæ™‚æ®µã€‚</p>
            </div>
        </section>

        <!-- Navigation Tabs (Main Controller) -->
        <nav class="sticky top-2 z-40 bg-stone-100/90 backdrop-blur-sm py-2 rounded-xl border border-stone-200 shadow-md">
            <div class="flex overflow-x-auto gap-2 px-2 hide-scroll" id="dayTabs">
                <!-- JS will populate these buttons -->
            </div>
        </nav>

        <!-- Dynamic Content Section -->
        <main id="mainContent" class="min-h-[500px]">
            <!-- Content injected by JS -->
            <div class="flex flex-col items-center justify-center h-64 text-stone-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-stone-500 mb-2"></div>
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </main>

        <!-- Secondary Charts Section -->
        <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-stone-800">âš¡ é ä¼°å¼·åº¦ vs æ‰‹æ©Ÿå¯¦éš›æ­¥æ•¸</h2>
            </div>
            <p class="text-sm text-stone-500 mb-6">é•·æ¢åœ–ç‚ºé ä¼°ç–²å‹åº¦ï¼Œ<span class="text-blue-600 font-bold">æŠ˜ç·šç‚ºæ‚¨æ‰‹å‹•è¼¸å…¥çš„æ‰‹æ©Ÿæ­¥æ•¸</span>ã€‚</p>
            <div class="chart-container">
                <canvas id="intensityChart"></canvas>
            </div>
        </section>

        <!-- Photo Missions & Shopping Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Photo Missions -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-stone-800">ğŸ¥ æ”å½± & Reels ä»»å‹™</h2>
                    <span id="photoProgress" class="text-sm font-bold text-amber-600 bg-amber-100 px-3 py-1 rounded-full">0/10 å®Œæˆ</span>
                </div>
                <p class="text-sm text-stone-500 mb-4">é»æ“Šé …ç›®æ¨™è¨˜å®Œæˆï¼ˆå³æ™‚åŒæ­¥ï¼‰ã€‚</p>
                
                <div class="space-y-3" id="photoChecklist">
                    <!-- JS Populated -->
                </div>
            </section>

            <!-- Shopping Logistics -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-stone-800">ğŸ›ï¸ è³¼ç‰© & ä¼´æ‰‹ç¦®æ¸…å–®</h2>
                    <span id="shopProgress" class="text-sm font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">0/12 è³¼å…¥</span>
                </div>
                 <p class="text-sm text-stone-500 mb-4">é»æ“Šé …ç›®ä»¥æ¨™è¨˜ç‚ºã€Œå·²è³¼å…¥ã€ï¼ˆå³æ™‚åŒæ­¥ï¼‰ã€‚</p>
                <div class="space-y-3" id="shoppingChecklist">
                    <!-- JS Populated -->
                </div>
            </section>
        </div>

        <!-- NEW: Expenses & Tickets Summary -->
        <section class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
            <h2 class="text-xl font-bold text-stone-800 mb-4">ğŸ’° è²»ç”¨ç¸½è¡¨ (é ä»˜ + æ¯æ—¥è¨˜å¸³)</h2>
            <p class="text-sm text-stone-500 mb-4">æ‰€æœ‰é›»å­æ†‘è­‰å‡åœ¨ä¿¡ç®± <span class="font-mono bg-stone-100 px-1 rounded text-stone-700">daniel79865</span> ä¸­ã€‚æ¯æ—¥è¨˜å¸³å°‡è‡ªå‹•åŒ¯ç¸½æ–¼æ­¤ã€‚</p>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-stone-600" id="expensesTable">
                    <!-- JS will populate this table completely -->
                </table>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-stone-400 text-sm py-8 border-t border-stone-200">
            <p>2025 Tokyo & Fuji Solo Trip â€¢ Photography Itinerary</p>
            <p class="mt-2 text-xs">Remember to check weather forecasts for Mt. Fuji visibility.</p>
        </footer>

    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables & State ---
        const TRIP_ID = 'tokyo_fuji_2025_fixed_v1'; // å›ºå®š Trip ID
        let currentDayIndex = 0;
        let checkedPhotos = new Set();
        let checkedShop = new Set();
        let dailyRoutineState = {};
        let stepCounts = {}; 
        let customExpenses = []; // Array of { id, dayIndex, name, price }
        
        // Chart instances
        let chartInstance = null; 
        let focusChartInstance = null;
        
        // Firebase Globals
        let db;
        let docRef;

        // --- Static Data ---
        
        // Fixed Expenses Data (Moved from HTML to JS for easier merging)
        const fixedExpenses = [
            { name: "æ±äº¬ä¸ƒå¤©å…­å¤œä½å®¿", platform: "Agoda", details: "å‰ 6 æ™š + å¾Œ 1 æ™š (çµ„åˆ)", price: 7949 },
            { name: "æ©Ÿç¥¨ä¾†å›", platform: "Agoda", details: "TPE <-> NRT/HND", price: 9588 },
            { name: "å¯Œå£«å±±4å¤©3å¤œ + æ±äº¬1æ™š", platform: "Booking", details: "4543 (å¯Œå£«) + 1695 (æ±äº¬)", price: 6238 },
            { name: "Shibuya Sky é–€ç¥¨", platform: "å®˜ç¶²", details: "1/5 ä¸‹åˆ 3:00", price: 680, highlight: true },
            { name: "teamLab Borderless", platform: "Klook", details: "1/6 11:30 æ•¸ä½è—è¡“ç¾è¡“é¤¨", price: 958, highlight: true },
            { name: "æ–°å®¿-æ²³å£æ¹– å…¬è»Šä¾†å›", platform: "é ç´„", details: "å»:1/7 1109, å›:1/10 1106", price: 888 },
            { name: "å¯Œå£«å±±å…¨æ™¯ç´¢é“çºœè»Š", platform: "Klook", details: "1/8 å¾€è¿”ç¥¨", price: 201, highlight: true },
            { name: "eSIM ç¶²å¡", platform: "KKday", details: "æ—¥æœ¬ä¸Šç¶²", price: 287 }
        ];

        const itineraryData = [
            {
                day: 1,
                date: "1/1 (å››)",
                title: "æ—¥æœ¬æ©‹ãƒ»çš‡å±…ãƒ»æ–°å®¿ãƒ»éŠ€åº§",
                tag: "é«”åŠ›æŒ‘æˆ°",
                intensity: 9,
                location: "Tokyo",
                highlights: [
                    "ä¸Šåˆï¼šæ—¥æœ¬æ©‹éº’éºŸåƒ (ç¶“å…¸åœ°æ¨™)",
                    "ä¸Šåˆï¼šçš‡å±…å‰å»£å ´ & å’Œç”°å€‰å™´æ°´å…¬åœ’",
                    "åˆé¤ï¼šShake Shack éŠ€åº§",
                    "ä¸‹åˆï¼šé ˆè³€ç¥ç¤¾ (ä½ çš„åå­—éšæ¢¯)",
                    "ä¸‹åˆï¼šæ±äº¬éƒ½å»³åŒ—å±•æœ›å®¤ (æ–°å®¿å¤•é™½)",
                    "æ™šä¸Šï¼šéŠ€åº§æ­Œèˆä¼åº§å¤œæ‹ & ä¸­å¤®é€š"
                ],
                food: "Shake Shack, Blue Bottle, éŠ€åº§å‘¨é‚Šæ™šé¤",
                tips: "å…ƒæ—¦å¾ˆå¤šåº—æ²’é–‹ï¼Œç™¾è²¨å…¬å¸ä¼‘æ¯ã€‚ç¥ç¤¾äººæ½®çœ¾å¤šã€‚"
            },
            {
                day: 2,
                date: "1/2 (äº”)",
                title: "ç§‹è‘‰åŸå»ºç¯‰ & æ–°å®¿è³¼ç‰©",
                tag: "æ”å½±+è³¼ç‰©",
                intensity: 6,
                location: "Tokyo",
                highlights: [
                    "09:00 ç¥ç”°è¬ä¸–æ©‹ (ç´…ç£šæ‹±é–€)",
                    "10:00 è–æ©‹ (é›»è»Šäº¤æœƒ)",
                    "11:00 2k540 é«˜æ¶æ©‹ä¸‹è·äººè¡—",
                    "åˆé¤ï¼šæ•˜æ•˜é™¢ ç‡’è‚‰ (12:30 é ç´„)",
                    "ä¸‹åˆï¼šç§‹è‘‰åŸ/æ–°å®¿ è³¼ç‰©ç‹‚æ­¡ (å‹•æ¼«å‘¨é‚Š)",
                    "æ™šä¸Šï¼šç§‹è‘‰åŸè‡ªç”±æ´»å‹•"
                ],
                food: "æ•˜æ•˜é™¢ (12:30 é ç´„)",
                tips: "æ—©ä¸Šé›†ä¸­æ‹æ”å»ºç¯‰ï¼Œä¸‹åˆå°ˆå¿ƒè²·æ±è¥¿ã€‚"
            },
            {
                day: 3,
                date: "1/3 (å…­)",
                title: "ä¸‹ç”ºé¢¨æƒ…ï¼šæ™´ç©ºå¡”ãƒ»æ·ºè‰ãƒ»è°·æ ¹åƒ",
                tag: "æ–‡åŒ–æ”å½±",
                intensity: 7,
                location: "Tokyo",
                highlights: [
                    "æ¸…æ™¨ï¼šåé–“æ©‹ (æ™´ç©ºå¡”å€’å½±)",
                    "ä¸Šåˆï¼šæ·ºè‰é›·é–€ (äººåŠ›è»Šç•«é¢)",
                    "ä¸‹åˆï¼šä¸Šé‡ä¹‹æ£® Sakura Terrace (æ‹è»Šç«™)",
                    "ä¸‹åˆï¼šæ±äº¬å¤§å­¸ & è°·ä¸­éŠ€åº§ã€Œå¤•é™½éšæ¢¯ã€",
                    "æ™šé¤ï¼šè‚‰å±‹æ©«ç”º (18:00 é ç´„)"
                ],
                food: "æ·ºè‰é°»é­šé£¯, è‚‰å±‹æ©«ç”º (18:00 é ç´„)",
                tips: "è°·ä¸­éŠ€åº§å¤•é™½å¿…æ‹ã€‚"
            },
            {
                day: 4,
                date: "1/4 (æ—¥)",
                title: "è³½é¦¬æ—¥ & ç§‹è‘‰åŸå¤œç”Ÿæ´»",
                tag: "ç†±è¡€",
                intensity: 8,
                location: "Chiba/Tokyo",
                highlights: [
                    "å…¨æ—¥ï¼šä¸­å±±ç«¶é¦¬å ´ (ä¸­å±±é‡‘æ¯ GIII)",
                    "æ‹æ”ï¼šè¬é¦¬å¥”é¨°ã€å¸•å¤šå…‹é¦¬åŒ¹ç‹€æ…‹",
                    "æ·±å¤œï¼šMOGRA (ç§‹è‘‰åŸ DJ Bar)",
                    "Option: 63 angel"
                ],
                food: "é¦¬å ´å…§Bç´šç¾é£Ÿ",
                tips: "é€±å…­æ™šä¸Šå¤œåº—æ°£æ°›æœ€ä½³ã€‚"
            },
            {
                day: 5,
                date: "1/5 (ä¸€)",
                title: "ä»£å®˜å±±ãƒ»æ¾€è°· SKY",
                tag: "æ™‚å°šè¡—æ‹",
                intensity: 6,
                location: "Tokyo",
                highlights: [
                    "ä¸Šåˆï¼šä»£å®˜å±± è”¦å±‹æ›¸åº—",
                    "ä¸‹åˆï¼šæƒ æ¯”å£½èŠ±åœ’å»£å ´å¡”",
                    "15:00 SHIBUYA SKY (å·²é ç´„/è³¼ç¥¨)",
                    "æ™šä¸Šï¼šæ¾€è°·åå­—è·¯å£æ˜Ÿå·´å…‹",
                    "æ™šé¤ï¼šTerumae å±…é…’å±‹ (19:00 é ç´„)"
                ],
                food: "ç‚¸ç‰›æ’, Terumae (19:00 é ç´„)",
                tips: "SHIBUYA SKY ä¸‹åˆ3é»å…¥å ´ï¼Œå¯ä¸€è·¯æ‹åˆ°å¤•é™½ã€‚"
            },
            {
                day: 6,
                date: "1/6 (äºŒ)",
                title: "éº»å¸ƒå°ãƒ»æ±äº¬å¡”",
                tag: "è—è¡“çµ•æ™¯",
                intensity: 5,
                location: "Tokyo",
                highlights: [
                    "11:30 teamLab Borderless (éº»å¸ƒå°Hills)",
                    "æ‹æ”ï¼šç¥è°·ç”ºè»Šç«™å‡ºå£æ›²ç·š",
                    "æ‹æ”ï¼šèŠå…¬åœ’ (æ±äº¬éµå¡”)",
                    "æ·±å¤œï¼šLive House"
                ],
                food: "é›æ¹¯æ‹‰éºµ ç¯",
                tips: "teamLab å·²è³¼ç¥¨ 11:30 å…¥å ´ã€‚"
            },
            {
                day: 7,
                date: "1/7 (ä¸‰)",
                title: "ç§»å‹•æ—¥ï¼šæ±äº¬ â†’ æ²³å£æ¹–",
                tag: "ç§»å‹•/é¢¨æ™¯",
                intensity: 4,
                location: "Fuji",
                highlights: [
                    "13:15 æ–°å®¿é«˜é€Ÿå·´å£« (è»Šæ¬¡1109)",
                    "åˆé¤ï¼šç‚¸ç‰›æ’ Koushuya (æ²³å£æ¹–åº—)",
                    "ä¸‹åˆï¼šæ–°å€‰å±±æ·ºé–“å…¬åœ’ (å¿ éˆå¡”+å¯Œå£«å±±)",
                    "æ‹æ”ï¼šæœ¬ç”ºäºŒä¸ç›®å•†åº—è¡—"
                ],
                food: "ç‚¸ç‰›æ’ Koushuya",
                tips: "æ–°å€‰å±±æ·ºé–“å…¬åœ’éœ€çˆ¬398éšæ¢¯ã€‚è¨˜å¾—æå‰åˆ°æ–°å®¿å·´å£«ç¸½ç«™ã€‚"
            },
            {
                day: 8,
                date: "1/8 (å››)",
                title: "æ²³å£æ¹–ç’°æ¹–æ”å½±",
                tag: "è‡ªç„¶é¢¨å…‰",
                intensity: 7,
                location: "Fuji",
                highlights: [
                    "æ¸…æ™¨ï¼šæ¹–ç•”æ—¥å‡º (é€†å¯Œå£« - é•·å´å…¬åœ’/ç”¢å±‹å´)",
                    "æ™¯é»ï¼šå¤§çŸ³å…¬åœ’ (èŠ±æµ·+å¯Œå£«å±±)",
                    "æ™¯é»ï¼šéŸ³æ¨‚ç›’ä¹‹æ£®ç¾è¡“é¤¨",
                    "æ™¯é»ï¼šå¤©ä¸Šå±±çºœè»Š (Kachi Kachi Ropeway)"
                ],
                food: "æ²³å£æ¹–å‘¨é‚Š",
                tips: "é€†å¯Œå£«éœ€è¦ç„¡é¢¨ç„¡é›¨çš„æ¸…æ™¨ã€‚çºœè»Šç¥¨Klookå·²è²·ã€‚"
            },
            {
                day: 9,
                date: "1/9 (äº”)",
                title: "å¿é‡å…«æµ·",
                tag: "å‚³çµ±å»ºç¯‰",
                intensity: 5,
                location: "Fuji",
                highlights: [
                    "å…¨æ—¥ï¼šå¿é‡å…«æµ·",
                    "æ‹æ”ï¼šé¡æ±  (é€†å¯Œå£«)ã€æ¹§æ± ",
                    "æ‹æ”ï¼šå‚³çµ±èŒ…è‘ºå±‹é ‚å»ºç¯‰"
                ],
                food: "å¿é‡å…«æµ·å°åƒ",
                tips: "éŠå®¢æ¥µå¤šï¼Œå»ºè­°9é»å‰æŠµé”ã€‚"
            },
            {
                day: 10,
                date: "1/10 (å…­)",
                title: "å¯Œå£«æ€¥ãƒ»å›æ±äº¬",
                tag: "éŠæ¨‚/ç§»å‹•",
                intensity: 6,
                location: "Fuji/Tokyo",
                highlights: [
                    "ä¸Šåˆï¼šå¯Œå£«è¦‹æ©‹ (å¯Œå£«å±±é“è·¯ç›¡é ­æ„Ÿ)",
                    "11:10 æ²³å£æ¹–ç™¼è»Šå›æ–°å®¿ (è»Šæ¬¡1106)",
                    "ä¸‹åˆï¼šæ±äº¬æœ€å¾Œè¡åˆº",
                    "å‚æ™šï¼šå…¥ä½æœ€å¾Œä¸€æ™šä½å®¿"
                ],
                food: "æ±äº¬å¸‚å€",
                tips: "è¨˜å¾— 11:10 å‰å›åˆ°æ²³å£æ¹–è»Šç«™æ­è»Šã€‚"
            },
            {
                day: 11,
                date: "1/11 (æ—¥)",
                title: "å›ç¨‹",
                tag: "è¿”å®¶",
                intensity: 2,
                location: "Airport",
                highlights: [
                    "ä¸Šåˆï¼šç¾½ç”°æ©Ÿå ´ (HND) -> å°åŒ— (TPE)",
                    "æœ€å¾Œè¡åˆºï¼šæ©Ÿå ´ä¼´æ‰‹ç¦® (æ±äº¬é¦™è•‰ã€è–¯æ¢ä¸‰å…„å¼Ÿ)"
                ],
                food: "é£›æ©Ÿé¤",
                tips: "æ³¨æ„é›»è»Šé¦–ç­è»Šæ™‚é–“ã€‚"
            }
        ];

        const photoMissions = [
            { id: 1, text: "Day 1: éŠ€åº§/æœ‰æ¨‚ç”º è»Šè»Œå¤œæ™¯ (é•·æ›å…‰)", type: "Photo" },
            { id: 2, text: "Day 2: è–æ©‹ ä¸‰ç·šé›»è»Šäº¤æœƒ", type: "Photo" },
            { id: 3, text: "Day 3: åé–“æ©‹ æ™´ç©ºå¡”å®Œç¾å€’å½±", type: "Photo" },
            { id: 4, text: "Day 3: è°·ä¸­éŠ€åº§ å¤•é™½éšæ¢¯å‰ªå½±", type: "Photo" },
            { id: 5, text: "Day 4: ä¸­å±±ç«¶é¦¬å ´ è¬é¦¬å¥”é¨° (Panning)", type: "Photo" },
            { id: 6, text: "Day 5: SHIBUYA SKY ç™¾è¬å¤œæ™¯ (æ¶ˆåå…‰)", type: "Photo" },
            { id: 7, text: "Day 6: teamLab Borderless äººåƒå‰ªå½±", type: "Photo" },
            { id: 8, text: "Day 6: èŠå…¬åœ’ ç´…ç™½æ±äº¬éµå¡”", type: "Photo" },
            { id: 9, text: "Day 7: ä¸‹å‰ç”° æœ¬ç”ºäºŒä¸ç›® é•·ç„¦å£“ç¸®æ„Ÿ", type: "Photo" },
            { id: 10, text: "Day 8: æ²³å£æ¹– é€†å¯Œå£« (æ¸…æ™¨)", type: "Photo" },
            { id: 11, text: "Reel: 'The Next Station is Tokyo' (15å¼µè¸©é»)", type: "Video" },
            { id: 12, text: "Reel: Shibuya Sky x å¤©æ°£ä¹‹å­ (POV)", type: "Video" }
        ];

        const shoppingList = [
            { item: "çŒ©çŒ©ä¹‹æ¡ (ç›¸æ©Ÿè…³æ¶)", loc: "Yodobashi Akiba", cat: "Gear" },
            { item: "æ¸›è‚¥è—¥ (Onaka/Naishi)", loc: "æ¾æœ¬æ¸…/OS Drug", cat: "Drugstore" },
            { item: "è€åª½çš„èƒŒå¿ƒ", loc: "Uniqlo éŠ€åº§/Montbell", cat: "Clothing" },
            { item: "New York Perfect Cheese", loc: "æ±äº¬ç«™/æ–°å®¿", cat: "Souvenir" },
            { item: "ç™½è‰²æˆ€äºº", loc: "æ©Ÿå ´/æ—¥æœ¬æ©‹", cat: "Souvenir" },
            { item: "Royce ç”Ÿå·§å…‹åŠ›", loc: "æ©Ÿå ´", cat: "Souvenir" },
            { item: "YoroshiåŒ–ç²§å ‚ 365è­·å”‡è†", loc: "æ·ºè‰", cat: "Souvenir" },
            { item: "FUJIYAMA COOKIE", loc: "æ²³å£æ¹–", cat: "Souvenir" },
            { item: "LAWSON è‰è“ç‰›å¥¶", loc: "ä¾¿åˆ©å•†åº—", cat: "Daily Eat" },
            { item: "OHAYO ç„¦ç³–çƒ¤å¸ƒè•¾å†°æ·‡æ·‹", loc: "ä¾¿åˆ©å•†åº—", cat: "Daily Eat" },
            { item: "æ¯æ™šä¸€ç½å•¤é…’", loc: "ä¾¿åˆ©å•†åº—", cat: "Daily Eat" },
            { item: "Sweet Gardenå¯Œå£«é›ªç²‰èµ·å£«è›‹ç³•", loc: "æ²³å£æ¹–", cat: "Daily Eat" }
        ];
        
        const dailyRoutineItems = [
            { id: 'run', text: 'æ™¨é–“è·‘æ­¥ / æ•£æ­¥', icon: 'ğŸƒ', isFujiOnly: false },
            { id: 'milk', text: 'LAWSON è‰è“ç‰›å¥¶', icon: 'ğŸ“', isFujiOnly: false },
            { id: 'icecream', text: 'OHAYO ç„¦ç³–çƒ¤å¸ƒè•¾å†°æ·‡æ·‹', icon: 'ğŸ®', isFujiOnly: false },
            { id: 'beer', text: 'å–ä¸€ç½å•¤é…’', icon: 'ğŸº', isFujiOnly: false },
            { id: 'fuji_cake', text: 'Sweet Gardenå¯Œå£«é›ªç²‰èµ·å£«è›‹ç³•', icon: 'ğŸ—»', isFujiOnly: true }
        ];

        // --- Core Interaction Functions ---

        window.toggleRoutine = function(dayIndex, itemId) {
            const stateKey = `${dayIndex}_${itemId}`;
            dailyRoutineState[stateKey] = !dailyRoutineState[stateKey];
            renderContent(dayIndex);
            syncState(); 
        };

        window.togglePhoto = function(idx) {
            if (checkedPhotos.has(idx)) checkedPhotos.delete(idx);
            else checkedPhotos.add(idx);
            renderChecklists();
            syncState();
        };

        window.toggleShop = function(idx) {
            if (checkedShop.has(idx)) checkedShop.delete(idx);
            else checkedShop.add(idx);
            renderChecklists();
            syncState();
        };

        window.updateSteps = function(dayIndex, value) {
            stepCounts[dayIndex] = parseInt(value) || 0;
            renderCharts(); 
            syncState();
        };

        // NEW: Expense Functions
        window.addExpense = function(dayIndex) {
            const nameInput = document.getElementById(`expense-name-${dayIndex}`);
            const priceInput = document.getElementById(`expense-price-${dayIndex}`);
            
            const name = nameInput.value.trim();
            const price = parseInt(priceInput.value);

            if (!name || isNaN(price)) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®åç¨±èˆ‡é‡‘é¡");
                return;
            }

            const newExpense = {
                id: Date.now().toString(), // Simple ID
                dayIndex: dayIndex,
                name: name,
                price: price
            };

            customExpenses.push(newExpense);
            
            // Clear inputs
            nameInput.value = "";
            priceInput.value = "";

            renderContent(dayIndex); // Refresh daily view
            renderExpensesTable(); // Refresh summary table
            syncState();
        };

        window.deleteExpense = function(expenseId, dayIndex) {
            customExpenses = customExpenses.filter(e => e.id !== expenseId);
            renderContent(dayIndex);
            renderExpensesTable();
            syncState();
        };

        // --- Render Functions ---

        const dayTabs = document.getElementById('dayTabs');
        const mainContent = document.getElementById('mainContent');
        const photoChecklist = document.getElementById('photoChecklist');
        const shoppingChecklist = document.getElementById('shoppingChecklist');
        const photoProgress = document.getElementById('photoProgress');
        const shopProgress = document.getElementById('shopProgress');
        const expensesTable = document.getElementById('expensesTable');

        function renderTabs() {
            dayTabs.innerHTML = '';
            itineraryData.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 px-5 py-2 rounded-lg text-sm font-medium transition-all duration-200 border ${index === currentDayIndex ? 'active-tab shadow-md' : 'inactive-tab'}`;
                btn.textContent = `Day ${day.day}`;
                btn.onclick = () => {
                    currentDayIndex = index;
                    renderTabs();
                    renderContent(index);
                };
                dayTabs.appendChild(btn);
            });
        }

        function renderContent(index) {
            const data = itineraryData[index];
            const isFujiArea = data.location === 'Fuji' || data.location.includes('Fuji');
            const currentSteps = stepCounts[index] || '';
            
            // Get expenses for this day
            const dailyExpenses = customExpenses.filter(e => e.dayIndex === index);
            const dailyTotal = dailyExpenses.reduce((sum, e) => sum + e.price, 0);

            // Generate Daily Routine HTML
            let routineHtml = '';
            dailyRoutineItems.forEach(item => {
                if (item.isFujiOnly && !isFujiArea) return;
                
                const stateKey = `${index}_${item.id}`;
                const isChecked = dailyRoutineState[stateKey] || false;
                
                routineHtml += `
                    <div class="flex items-center gap-3 p-3 mb-2 rounded-lg cursor-pointer transition-all ${isChecked ? 'bg-green-50 border border-green-200' : 'bg-white border border-stone-200 hover:border-stone-400'}" 
                            onclick="window.toggleRoutine(${index}, '${item.id}')">
                        <div class="w-5 h-5 flex items-center justify-center rounded border ${isChecked ? 'bg-green-500 border-green-500 text-white' : 'border-stone-300'}">
                            ${isChecked ? 'âœ“' : ''}
                        </div>
                        <div class="flex-1 text-sm font-medium ${isChecked ? 'text-stone-400 line-through' : 'text-stone-700'}">
                            <span class="mr-1">${item.icon}</span> ${item.text}
                        </div>
                    </div>
                `;
            });

            // Generate Expense List HTML
            let expensesListHtml = '';
            if (dailyExpenses.length > 0) {
                expensesListHtml = `<div class="mt-3 space-y-2">`;
                dailyExpenses.forEach(exp => {
                    expensesListHtml += `
                        <div class="flex justify-between items-center bg-white p-2 rounded border border-stone-100 expense-item">
                            <span class="text-sm text-stone-700">${exp.name}</span>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-mono text-stone-600">$${exp.price}</span>
                                <button onclick="window.deleteExpense('${exp.id}', ${index})" class="text-red-400 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
                expensesListHtml += `</div>`;
            } else {
                expensesListHtml = `<p class="text-xs text-stone-400 mt-2 text-center italic">ä»Šæ—¥å°šæœªæ–°å¢æ¶ˆè²»</p>`;
            }

            mainContent.innerHTML = `
                <div class="bg-white rounded-3xl shadow-lg border border-stone-200 overflow-hidden relative">
                    <!-- Hero Header for the Card -->
                    <div class="p-8 ${isFujiArea ? 'bg-gradient-to-r from-blue-50 to-indigo-50' : 'bg-gradient-to-r from-amber-50 to-orange-50'}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-3xl font-bold text-stone-800 mb-2">${data.date} ${data.title}</h2>
                                <div class="flex gap-2">
                                    <span class="px-3 py-1 text-xs font-bold uppercase tracking-wide rounded-full bg-white text-stone-600 border border-stone-200">
                                        ğŸ“ ${data.location}
                                    </span>
                                    <span class="px-3 py-1 text-xs font-bold uppercase tracking-wide rounded-full ${data.intensity >= 8 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                        âš¡ å¼·åº¦: ${data.intensity}/10
                                    </span>
                                    <span class="px-3 py-1 text-xs font-bold uppercase tracking-wide rounded-full bg-stone-800 text-white">
                                        ${data.tag}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-8">
                        <!-- Layout Grid: Highlights (Left) & Right Sidebar -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                            
                            <!-- Column 1: Highlights (Takes up 2/3 space) -->
                            <div class="lg:col-span-2 space-y-6">
                                <div>
                                    <h3 class="text-lg font-bold text-stone-700 mb-4 border-b pb-2 border-stone-100">è¡Œç¨‹äº®é»</h3>
                                    <ul class="space-y-4">
                                        ${data.highlights.map(item => `
                                            <li class="flex items-start gap-3">
                                                <span class="mt-1.5 w-2 h-2 rounded-full ${item.includes('è»Šæ¬¡') || item.includes('é ç´„') ? 'bg-blue-500' : (item.includes('æ‹æ”') ? 'bg-red-500' : 'bg-amber-500')} flex-shrink-0"></span>
                                                <span class="text-stone-700 leading-relaxed ${item.includes('è»Šæ¬¡') || item.includes('é ç´„') ? 'font-bold' : ''}">${item}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>

                                <!-- Step Count Input -->
                                <div class="bg-white border border-blue-200 rounded-xl p-4 flex items-center justify-between shadow-sm">
                                    <div class="flex items-center gap-3">
                                         <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.85-2.98 5.54-3 8h6c.02-2.46-2.98-5.15-3-8 0-4.2 1.63-6 3.5-6 3.01 0 4.47 3.28 4.5 6 .03 2.5-1 3.5-1 5.62V16h-1v6h2v-6h1v6h2v-6h1v-2c0-2.31.7-3.58 1-5H3c.3 1.42 1 2.69 1 5v2h1v-6h1v6h2v-6h1v6h2v-6z"></path></svg>
                                         </div>
                                         <div>
                                             <h4 class="font-bold text-stone-700">æ‰‹æ©Ÿæ­¥æ•¸ç´€éŒ„</h4>
                                         </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="stepInput" 
                                               class="w-24 border border-stone-300 rounded-lg px-3 py-2 text-right font-mono focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none" 
                                               placeholder="0" 
                                               value="${currentSteps}"
                                               onchange="window.updateSteps(${index}, this.value)">
                                        <span class="text-sm text-stone-500">æ­¥</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Column 2: Sidebar (Routine + Expenses) -->
                            <div class="space-y-6">
                                <!-- Daily Routine -->
                                <div class="bg-stone-50 rounded-2xl p-5 border border-stone-100">
                                    <h3 class="text-sm font-bold text-stone-500 uppercase mb-3 flex items-center gap-2">
                                        <span>ğŸ“…</span> æ¯æ—¥å„€å¼ Checklist
                                    </h3>
                                    <div class="flex flex-col">
                                        ${routineHtml}
                                    </div>
                                </div>

                                <!-- NEW: Daily Expense Tracker -->
                                <div class="bg-indigo-50 rounded-2xl p-5 border border-indigo-100">
                                    <h3 class="text-sm font-bold text-indigo-800 uppercase mb-3 flex items-center gap-2 justify-between">
                                        <span>ğŸ’¸ ä»Šæ—¥è¨˜å¸³</span>
                                        <span class="text-xs bg-white px-2 py-0.5 rounded border border-indigo-100 text-indigo-600">å°è¨ˆ: $${dailyTotal}</span>
                                    </h3>
                                    
                                    <!-- Input Form -->
                                    <div class="flex gap-2 mb-3">
                                        <input type="text" id="expense-name-${index}" placeholder="é …ç›®" class="w-full rounded border border-stone-300 px-2 py-1 text-sm focus:outline-none focus:border-indigo-400">
                                        <input type="number" id="expense-price-${index}" placeholder="$" class="w-20 rounded border border-stone-300 px-2 py-1 text-sm focus:outline-none focus:border-indigo-400">
                                        <button onclick="window.addExpense(${index})" class="bg-indigo-600 text-white rounded px-3 py-1 text-sm hover:bg-indigo-700 transition-colors">+</button>
                                    </div>
                                    
                                    <!-- List -->
                                    ${expensesListHtml}
                                </div>
                            </div>
                        </div>

                        <!-- Footer Info Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-stone-50 p-4 rounded-xl">
                                <h4 class="text-sm font-bold text-stone-500 uppercase mb-2">ğŸ½ï¸ é¤é£² & é ç´„</h4>
                                <p class="text-stone-800 font-medium">${data.food}</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <h4 class="text-sm font-bold text-amber-600 uppercase mb-2">ğŸ’¡ æ”å½±ç­†è¨˜ / è²¼å¿ƒæé†’</h4>
                                <p class="text-stone-800 text-sm">${data.tips}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChecklists() {
            // Photo List
            photoChecklist.innerHTML = '';
            photoMissions.forEach((item, idx) => {
                const isChecked = checkedPhotos.has(idx);
                const div = document.createElement('div');
                div.className = `flex items-center justify-between gap-3 p-3 rounded-lg border transition-all ${isChecked ? 'bg-stone-50 border-stone-200' : 'bg-white border-stone-100 hover:border-amber-300 hover:shadow-sm'}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 cursor-pointer flex-grow" onclick="window.togglePhoto(${idx})">
                        <div class="w-5 h-5 rounded border flex items-center justify-center flex-shrink-0 ${isChecked ? 'bg-amber-500 border-amber-500 text-white' : 'border-stone-300'}">
                            ${isChecked ? 'âœ“' : ''}
                        </div>
                        <div>
                            <div class="text-sm font-medium ${isChecked ? 'line-through text-stone-400' : 'text-stone-700'}">${item.text}</div>
                            <div class="text-xs text-stone-400">${item.type}</div>
                        </div>
                    </div>
                `;
                photoChecklist.appendChild(div);
            });
            photoProgress.textContent = `${checkedPhotos.size}/${photoMissions.length} å®Œæˆ`;

            // Shopping List
            shoppingChecklist.innerHTML = '';
            shoppingList.forEach((item, idx) => {
                const isChecked = checkedShop.has(idx);
                const div = document.createElement('div');
                div.className = `flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${isChecked ? 'bg-stone-50 border-stone-200 opacity-60' : 'bg-white border-stone-100 hover:border-blue-300 hover:shadow-sm'}`;
                div.onclick = () => window.toggleShop(idx);
                div.innerHTML = `
                    <div class="w-5 h-5 rounded border flex items-center justify-center ${isChecked ? 'bg-blue-500 border-blue-500 text-white' : 'border-stone-300'}">
                        ${isChecked ? 'âœ“' : ''}
                    </div>
                    <div>
                        <div class="text-sm font-medium ${isChecked ? 'line-through text-stone-400' : 'text-stone-700'}">${item.item}</div>
                        <div class="text-xs text-stone-400">${item.loc} â€¢ ${item.cat}</div>
                    </div>
                `;
                shoppingChecklist.appendChild(div);
            });
            shopProgress.textContent = `${checkedShop.size}/${shoppingList.length} è³¼å…¥`;
        }

        function renderExpensesTable() {
            // Header
            let html = `
                <thead class="text-xs text-stone-700 uppercase bg-stone-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">é …ç›®</th>
                        <th scope="col" class="px-6 py-3">å¹³å°/é¡åˆ¥</th>
                        <th scope="col" class="px-6 py-3">è©³ç´°è³‡è¨Š / æ—¥æœŸ</th>
                        <th scope="col" class="px-6 py-3 text-right">é‡‘é¡ (TWD)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-stone-100">
            `;

            let grandTotal = 0;

            // 1. Fixed Expenses
            fixedExpenses.forEach(exp => {
                grandTotal += exp.price;
                html += `
                    <tr class="bg-white border-b hover:bg-stone-50">
                        <td class="px-6 py-4 font-medium text-stone-900">${exp.name}</td>
                        <td class="px-6 py-4">${exp.platform}</td>
                        <td class="px-6 py-4 ${exp.highlight ? 'text-amber-600 font-bold' : ''}">${exp.details}</td>
                        <td class="px-6 py-4 text-right">${exp.price.toLocaleString()}</td>
                    </tr>
                `;
            });

            // 2. Separator if custom expenses exist
            if (customExpenses.length > 0) {
                html += `
                    <tr class="bg-stone-100">
                        <td colspan="4" class="px-6 py-2 text-xs font-bold text-stone-500 uppercase text-center tracking-wider">
                            â¬‡ï¸ æ—…é€”è¨˜å¸³ (ç¾åœ°æ¶ˆè²») â¬‡ï¸
                        </td>
                    </tr>
                `;

                // Sort custom expenses by day
                const sortedCustom = [...customExpenses].sort((a, b) => a.dayIndex - b.dayIndex);

                sortedCustom.forEach(exp => {
                    grandTotal += exp.price;
                    html += `
                        <tr class="bg-indigo-50/30 border-b hover:bg-indigo-50">
                            <td class="px-6 py-4 font-medium text-stone-900">${exp.name}</td>
                            <td class="px-6 py-4 text-stone-500">æ¯æ—¥è¨˜å¸³</td>
                            <td class="px-6 py-4 text-indigo-600 font-medium">Day ${exp.dayIndex + 1}</td>
                            <td class="px-6 py-4 text-right">${exp.price.toLocaleString()}</td>
                        </tr>
                    `;
                });
            }

            // Footer Total
            html += `
                </tbody>
                <tfoot class="bg-stone-100 font-bold text-stone-900">
                    <tr>
                        <td scope="row" class="px-6 py-3 text-base">ç¸½è¨ˆ (TWD)</td>
                        <td class="px-6 py-3"></td>
                        <td class="px-6 py-3"></td>
                        <td class="px-6 py-3 text-right text-base text-indigo-700">${grandTotal.toLocaleString()}</td>
                    </tr>
                </tfoot>
            `;

            expensesTable.innerHTML = html;
        }

        function renderCharts() {
            try {
                if (typeof Chart === 'undefined') {
                    console.warn("Chart.js not loaded yet, skipping chart render");
                    return;
                }
                
                // Chart 1: Trip Focus (Donut)
                const ctxFocus = document.getElementById('focusChart')?.getContext('2d');
                if (ctxFocus) {
                    if (focusChartInstance) {
                        focusChartInstance.destroy();
                    }

                    focusChartInstance = new Chart(ctxFocus, {
                        type: 'doughnut',
                        data: {
                            labels: ['æ”å½± (Photography)', 'è³¼ç‰© (Shopping)', 'ç¾é£Ÿ (Dining)', 'ç§»å‹• (Transit)', 'è³½é¦¬/å¨›æ¨‚ (Ent)'],
                            datasets: [{
                                data: [45, 15, 20, 10, 10], 
                                backgroundColor: ['#d97706', '#3b82f6', '#10b981', '#6b7280', '#8b5cf6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' }
                            }
                        }
                    });
                }

                // Chart 2: Daily Intensity (Bar + Line)
                const ctxIntensity = document.getElementById('intensityChart')?.getContext('2d');
                if (ctxIntensity) {
                    const stepsData = itineraryData.map((_, i) => stepCounts[i] || 0);

                    if (chartInstance) {
                        chartInstance.destroy(); 
                    }

                    chartInstance = new Chart(ctxIntensity, {
                        type: 'bar',
                        data: {
                            labels: itineraryData.map(d => `Day ${d.day}`),
                            datasets: [
                                {
                                    label: 'é ä¼°å¼·åº¦ (1-10)',
                                    data: itineraryData.map(d => d.intensity),
                                    backgroundColor: itineraryData.map(d => d.intensity >= 8 ? '#fca5a5' : (d.intensity >= 6 ? '#fcd34d' : '#6ee7b7')), 
                                    borderRadius: 4,
                                    yAxisID: 'y',
                                    order: 2
                                },
                                {
                                    label: 'å¯¦éš›æ‰‹æ©Ÿæ­¥æ•¸',
                                    data: stepsData,
                                    borderColor: '#2563eb', 
                                    backgroundColor: '#2563eb',
                                    type: 'line',
                                    tension: 0.3,
                                    yAxisID: 'y1',
                                    order: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10,
                                    title: { display: true, text: 'å¼·åº¦' },
                                    grid: { display: false }
                                },
                                y1: {
                                    beginAtZero: true,
                                    position: 'right',
                                    title: { display: true, text: 'æ­¥æ•¸' },
                                    suggestedMax: 20000,
                                    grid: { drawOnChartArea: true } 
                                }
                            },
                            onClick: (e, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    currentDayIndex = index;
                                    renderTabs();
                                    renderContent(index);
                                    mainContent.scrollIntoView({ behavior: 'smooth' });
                                }
                            },
                            plugins: {
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            }
                        }
                    });
                }
            } catch (err) {
                console.error("Chart Render Error:", err);
            }
        }

        // --- Init Function ---

        async function initApp() {
            renderTabs();
            renderContent(0);
            renderChecklists();
            renderExpensesTable(); // Initial render of table
            
            try {
                if (typeof __firebase_config === 'undefined') {
                    console.warn("Firebase config not found in env");
                    return;
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (authErr) {
                    console.warn("Auth Error, trying anonymous fallback:", authErr);
                    if (!auth.currentUser) await signInAnonymously(auth);
                }

                // Firestore Sync
                docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trip_state', TRIP_ID);

                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        checkedPhotos = new Set(data.checkedPhotos || []);
                        checkedShop = new Set(data.checkedShop || []);
                        dailyRoutineState = data.dailyRoutine || {};
                        stepCounts = data.stepCounts || {}; 
                        customExpenses = data.customExpenses || []; // Sync expenses

                        // Update UI
                        renderChecklists();
                        renderCharts(); 
                        renderExpensesTable(); // Re-render table on sync
                        
                        // If viewing a specific day, we should probably re-render the content to show updated expense list
                        // But be careful not to wipe input focus if typing. 
                        // For simplicity, we only re-render the list if the current user isn't typing? 
                        // Actually, since we want to see additions immediately, we can re-render.
                        if (document.activeElement.tagName !== 'INPUT') {
                             renderContent(currentDayIndex);
                        }
                        
                    } else {
                         setDoc(docRef, { checkedPhotos: [], checkedShop: [], dailyRoutine: {}, stepCounts: {}, customExpenses: [] })
                           .catch(err => console.log("Create doc silent fail:", err));
                    }
                }, (err) => {
                    console.log("Sync paused:", err.code);
                });
                
                setTimeout(renderCharts, 100);

            } catch (err) {
                console.error("Firebase Init Error:", err);
                setTimeout(renderCharts, 100);
            }
        }

        function syncState() {
            if (!docRef) return;
            setDoc(docRef, {
                checkedPhotos: Array.from(checkedPhotos),
                checkedShop: Array.from(checkedShop),
                dailyRoutine: dailyRoutineState,
                stepCounts: stepCounts,
                customExpenses: customExpenses
            }, { merge: true }).catch(err => console.error("Sync Error:", err));
        }

        initApp();

    </script>
</body>
</html>
